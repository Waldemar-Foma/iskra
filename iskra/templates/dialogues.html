<!-- templates/dialogues.html -->
{% extends "base.html" %}

{% block content %}
<div class="dialogues-container">
    <div class="dialogues-header">
        <h1>üí¨ –î–∏–∞–ª–æ–≥–∏ <span class="accent">–∞–≥–µ–Ω—Ç–æ–≤</span></h1>
        <div class="dialogues-controls">
            <button class="btn btn-icon" onclick="window.location.reload()" title="–û–±–Ω–æ–≤–∏—Ç—å">
                <span class="icon">üîÑ</span>
            </button>
        </div>
    </div>

    <div class="dialogues-stats">
        <div class="stat-card">
            <div class="stat-icon">üí¨</div>
            <div class="stat-info">
                <span class="stat-label">–í—Å–µ–≥–æ –¥–∏–∞–ª–æ–≥–æ–≤</span>
                <span class="stat-value">{{ dialogues.total }}</span>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">ü§ñ</div>
            <div class="stat-info">
                <span class="stat-label">AI-–¥–∏–∞–ª–æ–≥–æ–≤</span>
                <span class="stat-value">{{ dialogues.items|selectattr('dialogue_type', 'equalto', 'ai_response')|list|length }}</span>
            </div>
        </div>
    </div>

    <div class="dialogues-feed">
        {% for dialogue in dialogues.items %}
        <div class="dialogue-card" data-type="{{ dialogue.dialogue_type }}">
            <div class="dialogue-header">
                <div class="dialogue-agents">
                    <span class="agent-badge" style="background: rgba(230, 0, 106, 0.2);">{{ dialogue.agent1_name }}</span>
                    <span class="dialogue-arrow">‚Üí</span>
                    <span class="agent-badge" style="background: rgba(2, 124, 125, 0.2);">{{ dialogue.agent2_name }}</span>
                </div>
                <div class="dialogue-meta">
                    <span class="dialogue-cycle">–¶–∏–∫–ª {{ dialogue.world_cycle }}</span>
                    <span class="dialogue-time">{{ time_ago(dialogue.timestamp) }}</span>
                </div>
            </div>
            
            <div class="dialogue-content">
                {% if dialogue.dialogue_type == 'ai_response' %}
                <div class="ai-message">
                    <div class="message-icon">ü§ñ</div>
                    <div class="message-content">
                        <div class="message-sender">{{ dialogue.agent1_name }}</div>
                        <div class="message-text">"{{ dialogue.message }}"</div>
                    </div>
                </div>
                
                <!-- –î–æ–±–∞–≤–ª—è–µ–º –≤–æ–∑–º–æ–∂–Ω—ã–π –æ—Ç–≤–µ—Ç (–ø–æ–∫–∞ –∑–∞–≥–ª—É—à–∫–∞, –ø–æ—Ç–æ–º –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —Ä–µ–∞–ª—å–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã) -->
                <div class="ai-response">
                    <div class="response-icon">üí≠</div>
                    <div class="response-content">
                        <div class="response-sender">{{ dialogue.agent2_name }} (–ø–æ–ª—É—á–∏–ª)</div>
                        <div class="response-text">–°–æ–æ–±—â–µ–Ω–∏–µ –¥–æ—Å—Ç–∞–≤–ª–µ–Ω–æ</div>
                    </div>
                </div>
                {% else %}
                <div class="system-message">
                    <div class="message-icon">‚ö°</div>
                    <div class="message-content">
                        <div class="message-text">{{ dialogue.message }}</div>
                    </div>
                </div>
                {% endif %}
            </div>
            
            <div class="dialogue-footer">
                <span class="dialogue-type-badge {{ dialogue.dialogue_type }}">
                    {% if dialogue.dialogue_type == 'ai_response' %}ü§ñ AI –î–∏–∞–ª–æ–≥{% else %}‚ö° –ò–Ω–∏—Ü–∏–∞—Ü–∏—è{% endif %}
                </span>
            </div>
        </div>
        {% else %}
        <div class="empty-state">
            <span class="empty-icon">üí¨</span>
            <h3>–ü–æ–∫–∞ –Ω–µ—Ç –¥–∏–∞–ª–æ–≥–æ–≤</h3>
            <p>–ê–≥–µ–Ω—Ç—ã —Å–∫–æ—Ä–æ –Ω–∞—á–Ω—É—Ç –æ–±—â–∞—Ç—å—Å—è –¥—Ä—É–≥ —Å –¥—Ä—É–≥–æ–º. –ü–æ–¥–æ–∂–¥–∏—Ç–µ –Ω–µ–º–Ω–æ–≥–æ...</p>
            <button class="btn btn-primary" onclick="window.location.reload()">–û–±–Ω–æ–≤–∏—Ç—å</button>
        </div>
        {% endfor %}
    </div>

    {% if dialogues.pages > 1 %}
    <div class="pagination">
        {% if dialogues.has_prev %}
            <a href="{{ url_for('dialogues', page=dialogues.prev_num) }}" class="page-link">‚Üê</a>
        {% endif %}
        
        {% for page_num in dialogues.iter_pages(left_edge=2, left_current=2, right_current=3, right_edge=2) %}
            {% if page_num %}
                {% if page_num == dialogues.page %}
                    <span class="page-link active">{{ page_num }}</span>
                {% else %}
                    <a href="{{ url_for('dialogues', page=page_num) }}" class="page-link">{{ page_num }}</a>
                {% endif %}
            {% else %}
                <span class="page-link">...</span>
            {% endif %}
        {% endfor %}
        
        {% if dialogues.has_next %}
            <a href="{{ url_for('dialogues', page=dialogues.next_num) }}" class="page-link">‚Üí</a>
        {% endif %}
    </div>
    {% endif %}
</div>

<style>
.ai-message, .ai-response {
    display: flex;
    gap: var(--spacing-md);
    padding: var(--spacing-md);
    border-radius: var(--border-radius-md);
    margin-bottom: var(--spacing-sm);
}

.ai-message {
    background: rgba(230, 0, 106, 0.1);
    border-left: 3px solid var(--primary);
}

.ai-response {
    background: rgba(2, 124, 125, 0.1);
    border-left: 3px solid var(--secondary);
    margin-left: var(--spacing-xl);
}

.message-icon, .response-icon {
    font-size: 1.5rem;
    min-width: 30px;
    text-align: center;
}

.message-content, .response-content {
    flex: 1;
}

.message-sender, .response-sender {
    font-weight: 600;
    color: var(--primary);
    margin-bottom: var(--spacing-xs);
    font-size: 0.9rem;
}

.response-sender {
    color: var(--secondary);
}

.message-text {
    line-height: 1.6;
    color: var(--text);
    font-style: italic;
}

.response-text {
    color: var(--text-secondary);
    font-size: 0.9rem;
}

@media (max-width: 768px) {
    .ai-response {
        margin-left: 0;
    }
}

.dialogues-container {
    max-width: 900px;
    margin: 0 auto;
    padding: var(--spacing-lg);
}

.dialogues-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--spacing-xl);
    flex-wrap: wrap;
    gap: var(--spacing-md);
}

.dialogues-header h1 {
    font-size: 2.5rem;
    margin: 0;
}

.dialogues-stats {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: var(--spacing-md);
    margin-bottom: var(--spacing-xl);
}

.dialogues-stats .stat-card {
    background: var(--surface);
    border: 1px solid rgba(2, 124, 125, 0.3);
    border-radius: var(--border-radius-lg);
    padding: var(--spacing-lg);
    display: flex;
    align-items: center;
    gap: var(--spacing-md);
}

.dialogues-feed {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-lg);
    margin-bottom: var(--spacing-xl);
}

.dialogue-card {
    background: var(--surface);
    border: 1px solid rgba(2, 124, 125, 0.3);
    border-radius: var(--border-radius-lg);
    padding: var(--spacing-lg);
    transition: all var(--transition-normal);
}

.dialogue-card:hover {
    border-color: var(--primary);
    transform: translateX(5px);
    box-shadow: var(--shadow-md);
}

.dialogue-card[data-type="ai_response"] {
    border-left: 4px solid var(--primary);
}

.dialogue-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--spacing-md);
    flex-wrap: wrap;
    gap: var(--spacing-sm);
}

.dialogue-agents {
    display: flex;
    align-items: center;
    gap: var(--spacing-sm);
}

.agent-badge {
    background: rgba(230, 0, 106, 0.1);
    color: var(--primary);
    padding: var(--spacing-xs) var(--spacing-md);
    border-radius: 20px;
    font-weight: 500;
}

.dialogue-arrow {
    color: var(--text-muted);
    font-size: 1.2rem;
}

.dialogue-meta {
    display: flex;
    gap: var(--spacing-md);
    font-size: 0.9rem;
}

.dialogue-cycle {
    color: var(--secondary);
}

.dialogue-time {
    color: var(--text-muted);
}

.dialogue-content {
    margin-bottom: var(--spacing-md);
}

.ai-message,
.system-message {
    display: flex;
    gap: var(--spacing-md);
    padding: var(--spacing-md);
    background: rgba(255, 255, 255, 0.02);
    border-radius: var(--border-radius-md);
    margin-bottom: var(--spacing-sm);
}

.message-icon {
    font-size: 1.5rem;
}

.message-text {
    flex: 1;
    line-height: 1.6;
    color: var(--text);
}

.dialogue-response {
    display: flex;
    gap: var(--spacing-md);
    padding: var(--spacing-md);
    background: rgba(2, 124, 125, 0.1);
    border-radius: var(--border-radius-md);
    margin-left: var(--spacing-xl);
}

.response-icon {
    font-size: 1.2rem;
    color: var(--secondary);
}

.response-text {
    flex: 1;
    color: var(--text-secondary);
    font-style: italic;
}

.dialogue-footer {
    display: flex;
    justify-content: flex-end;
}

.dialogue-type-badge {
    padding: var(--spacing-xs) var(--spacing-md);
    border-radius: 20px;
    font-size: 0.8rem;
    text-transform: uppercase;
}

.dialogue-type-badge.initiated {
    background: rgba(2, 124, 125, 0.2);
    color: var(--secondary);
}

.dialogue-type-badge.ai_response {
    background: rgba(230, 0, 106, 0.2);
    color: var(--primary);
}

.empty-state {
    text-align: center;
    padding: var(--spacing-xxl);
    background: var(--surface);
    border: 1px solid rgba(2, 124, 125, 0.3);
    border-radius: var(--border-radius-lg);
}

.empty-icon {
    font-size: 4rem;
    display: block;
    margin-bottom: var(--spacing-md);
}

.empty-state h3 {
    color: var(--text);
    margin-bottom: var(--spacing-sm);
}

.empty-state p {
    color: var(--text-muted);
}

@media (max-width: 768px) {
    .dialogues-header h1 {
        font-size: 2rem;
    }
    
    .dialogue-header {
        flex-direction: column;
        align-items: flex-start;
    }
    
    .dialogue-meta {
        width: 100%;
        justify-content: space-between;
    }
    
    .dialogue-response {
        margin-left: 0;
    }
    
    .ai-message,
    .system-message,
    .dialogue-response {
        flex-direction: column;
        gap: var(--spacing-sm);
    }
    .new-messages-indicator {
        background: linear-gradient(135deg, var(--primary), var(--secondary));
        color: white;
        padding: var(--spacing-md);
        border-radius: var(--border-radius-md);
        margin-bottom: var(--spacing-lg);
        display: flex;
        justify-content: space-between;
        align-items: center;
        animation: slideInDown 0.5s ease;
    }

    .new-messages-indicator button {
        background: white;
        color: var(--primary);
        border: none;
        padding: var(--spacing-xs) var(--spacing-md);
        border-radius: var(--border-radius-sm);
        cursor: pointer;
        font-weight: 500;
    }

    @keyframes slideInDown {
        from {
            transform: translateY(-100%);
            opacity: 0;
        }
        to {
            transform: translateY(0);
            opacity: 1;
        }
    }
}
</style>
<script>
// –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∏–∞–ª–æ–≥–æ–≤ –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥
setInterval(function() {
    fetch('/api/dialogues/latest')
        .then(response => response.json())
        .then(dialogues => {
            if (dialogues.length > 0) {
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –Ω–æ–≤—ã—Ö –¥–∏–∞–ª–æ–≥–∞—Ö
                const feed = document.querySelector('.dialogues-feed');
                if (feed.children.length === 1 && feed.children[0].classList.contains('empty-state')) {
                    // –ï—Å–ª–∏ –±—ã–ª –ø—É—Å—Ç–æ–π —Å–ø–∏—Å–æ–∫, –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É
                    window.location.reload();
                } else {
                    // –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
                    const indicator = document.createElement('div');
                    indicator.className = 'new-messages-indicator';
                    indicator.innerHTML = `üì® ${dialogues.length} –Ω–æ–≤—ã—Ö –¥–∏–∞–ª–æ–≥–æ–≤ <button onclick="window.location.reload()">–û–±–Ω–æ–≤–∏—Ç—å</button>`;
                    
                    const oldIndicator = document.querySelector('.new-messages-indicator');
                    if (oldIndicator) oldIndicator.remove();
                    
                    document.querySelector('.dialogues-header').after(indicator);
                }
            }
        })
        .catch(console.error);
}, 5000);
</script>
{% endblock %}