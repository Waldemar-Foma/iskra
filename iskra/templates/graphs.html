<!-- templates/graphs.html (fixed) -->
{% extends "base.html" %}

{% block content %}
<div class="graphs-container">
    <h2>Граф связей агентов</h2>
    <div class="graph-controls">
        <button class="btn btn-outline" onclick="refreshGraph()">⟳ Refresh</button>
        <button class="btn btn-outline" onclick="togglePhysics()">⚡ Physics</button>
    </div>
    <div class="graph-wrapper">
        <canvas id="agentGraph" width="800" height="600"></canvas>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const canvas = document.getElementById('agentGraph');
    const ctx = canvas.getContext('2d');
    
    // Mock data from server - properly escaped for JSON
    const nodes = {{ nodes | tojson | safe }};
    const links = {{ links | tojson | safe }};
    
    // Simple force-directed layout simulation
    const nodePositions = {};
    const centerX = 400;
    const centerY = 300;
    
    // Initialize positions in a circle
    if (nodes && nodes.length > 0) {
        nodes.forEach((node, i) => {
            const angle = (i / nodes.length) * 2 * Math.PI;
            nodePositions[node.id] = {
                x: centerX + 200 * Math.cos(angle),
                y: centerY + 200 * Math.sin(angle)
            };
        });
        
        // Draw links
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        if (links && links.length > 0) {
            links.forEach(link => {
                const source = nodePositions[link.source];
                const target = nodePositions[link.target];
                
                if (source && target) {
                    ctx.beginPath();
                    ctx.moveTo(source.x, source.y);
                    ctx.lineTo(target.x, target.y);
                    ctx.strokeStyle = '#027C7D';
                    ctx.lineWidth = Math.abs(link.value) * 3;
                    ctx.stroke();
                }
            });
        }
        
        // Draw nodes
        nodes.forEach(node => {
            const pos = nodePositions[node.id];
            
            if (pos) {
                // Node shadow
                ctx.shadowColor = '#E6006A';
                ctx.shadowBlur = 15;
                
                // Node circle
                ctx.beginPath();
                ctx.arc(pos.x, pos.y, 20, 0, 2 * Math.PI);
                ctx.fillStyle = '#000000';
                ctx.fill();
                ctx.strokeStyle = '#E6006A';
                ctx.lineWidth = 2;
                ctx.stroke();
                
                // Reset shadow for text
                ctx.shadowBlur = 0;
                
                // Node label
                ctx.fillStyle = '#FFFFFF';
                ctx.font = '12px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(node.id, pos.x, pos.y - 25);
            }
        });
    }
});

function refreshGraph() {
    location.reload();
}

function togglePhysics() {
    alert('Physics simulation toggled');
}
</script>
{% endblock %}