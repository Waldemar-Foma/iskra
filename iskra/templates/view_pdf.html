{% extends "base.html" %}

{% block content %}
<div class="pdf-viewer-container">
    <div class="pdf-header">
        <h1><i class="fas fa-file-pdf"></i> Просмотр документа</h1>
        <div class="pdf-controls">
            <button id="prevPage" class="pdf-nav-btn" disabled>
                <i class="fas fa-chevron-left"></i> Предыдущая
            </button>
            <span id="pageInfo">Страница <span id="currentPage">1</span> из <span id="totalPages">0</span></span>
            <button id="nextPage" class="pdf-nav-btn" disabled>
                Следующая <i class="fas fa-chevron-right"></i>
            </button>
        </div>
    </div>
    
    <div class="pdf-wrapper">
        <canvas id="pdfCanvas" class="pdf-canvas"></canvas>
    </div>
    
    <div class="pdf-footer">
        <div class="zoom-controls">
            <button id="zoomOut" class="zoom-btn" title="Уменьшить">
                <i class="fas fa-search-minus"></i>
            </button>
            <span id="zoomLevel">100%</span>
            <button id="zoomIn" class="zoom-btn" title="Увеличить">
                <i class="fas fa-search-plus"></i>
            </button>
            <button id="resetZoom" class="zoom-btn" title="Сбросить масштаб">
                <i class="fas fa-redo-alt"></i>
            </button>
        </div>
    </div>
</div>

<style>
.pdf-viewer-container {
    max-width: 1200px;
    margin: 20px auto;
    padding: 20px;
    background: #fff;
    border-radius: 12px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.1);
}

.pdf-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    padding-bottom: 15px;
    border-bottom: 2px solid #f0f0f0;
}

.pdf-header h1 {
    font-size: 1.5rem;
    color: #333;
    margin: 0;
    display: flex;
    align-items: center;
    gap: 10px;
}

.pdf-header h1 i {
    color: #e74c3c;
}

.pdf-controls {
    display: flex;
    align-items: center;
    gap: 15px;
}

.pdf-nav-btn {
    background: #3498db;
    color: white;
    border: none;
    padding: 8px 15px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 0.9rem;
    display: flex;
    align-items: center;
    gap: 5px;
    transition: background 0.3s;
}

.pdf-nav-btn:hover:not(:disabled) {
    background: #2980b9;
}

.pdf-nav-btn:disabled {
    background: #bdc3c7;
    cursor: not-allowed;
    opacity: 0.6;
}

#pageInfo {
    font-size: 0.95rem;
    color: #555;
    min-width: 150px;
    text-align: center;
}

.pdf-wrapper {
    background: #f5f5f5;
    border-radius: 8px;
    padding: 20px;
    min-height: 500px;
    display: flex;
    justify-content: center;
    align-items: center;
    overflow: auto;
    border: 1px solid #ddd;
    margin-bottom: 20px;
}

.pdf-canvas {
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    background: white;
    max-width: 100%;
    height: auto;
    display: block;
}

.pdf-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding-top: 15px;
    border-top: 2px solid #f0f0f0;
}

.zoom-controls {
    display: flex;
    align-items: center;
    gap: 8px;
}

.zoom-btn {
    background: #ecf0f1;
    border: none;
    width: 36px;
    height: 36px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 1rem;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background 0.3s;
}

.zoom-btn:hover {
    background: #d5dbdb;
}

#zoomLevel {
    min-width: 60px;
    text-align: center;
    font-size: 0.9rem;
    color: #555;
}

.download-section {
    display: flex;
    gap: 10px;
}

.download-btn {
    background: #27ae60;
    color: white;
    text-decoration: none;
    padding: 8px 20px;
    border-radius: 6px;
    font-size: 0.9rem;
    display: flex;
    align-items: center;
    gap: 8px;
    transition: background 0.3s;
}

.download-btn:hover {
    background: #219a52;
}

/* Адаптация для мобильных устройств */
@media (max-width: 768px) {
    .pdf-header {
        flex-direction: column;
        gap: 15px;
        align-items: flex-start;
    }
    
    .pdf-controls {
        width: 100%;
        justify-content: space-between;
    }
    
    .pdf-footer {
        flex-direction: column;
        gap: 15px;
        align-items: flex-start;
    }
    
    .download-section {
        width: 100%;
    }
    
    .download-btn {
        width: 100%;
        justify-content: center;
    }
}
</style>

<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Инициализация PDF.js
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';
    
    let pdfDoc = null;
    let pageNum = 1;
    let pageRendering = false;
    let pageNumPending = null;
    let scale = 1.0;
    const canvas = document.getElementById('pdfCanvas');
    const ctx = canvas.getContext('2d');
    
    // Загружаем PDF
    function loadPDF() {
        const url = "{{ url_for('static', filename='pdf/Document.pdf') }}";
        
        pdfjsLib.getDocument(url).promise.then(function(pdfDoc_) {
            pdfDoc = pdfDoc_;
            document.getElementById('totalPages').textContent = pdfDoc.numPages;
            
            // Включаем кнопки навигации
            document.getElementById('prevPage').disabled = false;
            document.getElementById('nextPage').disabled = false;
            
            // Рендерим первую страницу
            renderPage(pageNum);
        }).catch(function(error) {
            console.error('Ошибка загрузки PDF:', error);
            canvas.parentElement.innerHTML = '<div class="error-message">Не удалось загрузить PDF файл. Пожалуйста, проверьте наличие файла по пути: static/documents/sample.pdf</div>';
        });
    }
    
    // Рендеринг страницы
    function renderPage(num) {
        pageRendering = true;
        
        pdfDoc.getPage(num).then(function(page) {
            const viewport = page.getViewport({ scale: scale });
            canvas.height = viewport.height;
            canvas.width = viewport.width;
            
            const renderContext = {
                canvasContext: ctx,
                viewport: viewport
            };
            
            const renderTask = page.render(renderContext);
            
            renderTask.promise.then(function() {
                pageRendering = false;
                
                if (pageNumPending !== null) {
                    renderPage(pageNumPending);
                    pageNumPending = null;
                }
                
                // Обновляем информацию о странице
                document.getElementById('currentPage').textContent = num;
                
                // Обновляем состояние кнопок
                document.getElementById('prevPage').disabled = (num <= 1);
                document.getElementById('nextPage').disabled = (num >= pdfDoc.numPages);
            });
        });
    }
    
    // Очередь рендеринга страниц
    function queueRenderPage(num) {
        if (pageRendering) {
            pageNumPending = num;
        } else {
            renderPage(num);
        }
    }
    
    // Предыдущая страница
    document.getElementById('prevPage').addEventListener('click', function() {
        if (pageNum <= 1) return;
        pageNum--;
        queueRenderPage(pageNum);
    });
    
    // Следующая страница
    document.getElementById('nextPage').addEventListener('click', function() {
        if (pageNum >= pdfDoc.numPages) return;
        pageNum++;
        queueRenderPage(pageNum);
    });
    
    // Масштабирование
    document.getElementById('zoomIn').addEventListener('click', function() {
        scale += 0.1;
        if (scale > 3) scale = 3;
        document.getElementById('zoomLevel').textContent = Math.round(scale * 100) + '%';
        queueRenderPage(pageNum);
    });
    
    document.getElementById('zoomOut').addEventListener('click', function() {
        scale -= 0.1;
        if (scale < 0.5) scale = 0.5;
        document.getElementById('zoomLevel').textContent = Math.round(scale * 100) + '%';
        queueRenderPage(pageNum);
    });
    
    document.getElementById('resetZoom').addEventListener('click', function() {
        scale = 1.0;
        document.getElementById('zoomLevel').textContent = '100%';
        queueRenderPage(pageNum);
    });
    
    // Поддержка клавиатуры
    document.addEventListener('keydown', function(e) {
        if (e.key === 'ArrowLeft') {
            document.getElementById('prevPage').click();
        } else if (e.key === 'ArrowRight') {
            document.getElementById('nextPage').click();
        }
    });
    
    // Загружаем PDF
    loadPDF();
});
</script>
{% endblock %}