<!-- templates/world.html - –ü–æ–ª–Ω–æ—Å—Ç—å—é –ø–µ—Ä–µ—Ä–∞–±–æ—Ç–∞–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è -->
{% extends "base.html" %}

{% block content %}
<div class="world-container">
    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
    <div class="world-header">
        <h1>üåç –ú–∏—Ä <span class="accent">–∞–≥–µ–Ω—Ç–æ–≤</span></h1>
        <div class="world-controls">
            <button class="btn btn-icon" onclick="window.location.reload()" title="–û–±–Ω–æ–≤–∏—Ç—å">
                <span class="icon">üîÑ</span>
            </button>
        </div>
    </div>

    <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –º–∏—Ä–∞ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏ -->
    <div class="world-stats-panel">
        <div class="stat-card">
            <div class="stat-icon">üîÑ</div>
            <div class="stat-info">
                <span class="stat-label">–¢–µ–∫—É—â–∏–π —Ü–∏–∫–ª</span>
                <span class="stat-value" id="worldCycle">{{ world.cycle if world else 0 }}</span>
            </div>
        </div>
        
        <div class="stat-card">
            <div class="stat-icon">üìä</div>
            <div class="stat-info">
                <span class="stat-label">–°–ª–æ–∂–Ω–æ—Å—Ç—å</span>
                <span class="stat-value" id="worldComplexity">{{ "%.2f"|format(world.complexity) if world else "1.00" }}</span>
            </div>
        </div>
        
        <div class="stat-card">
            <div class="stat-icon">üë•</div>
            <div class="stat-info">
                <span class="stat-label">–í—Å–µ–≥–æ –∞–≥–µ–Ω—Ç–æ–≤</span>
                <span class="stat-value" id="totalAgents">{{ stats.total_agents }}</span>
            </div>
        </div>
        
        <div class="stat-card">
            <div class="stat-icon">‚ö°</div>
            <div class="stat-info">
                <span class="stat-label">–°—Ä–µ–¥–Ω—è—è —ç–Ω–µ—Ä–≥–∏—è</span>
                <span class="stat-value" id="avgEnergy">{{ "%.2f"|format(stats.avg_energy) }}</span>
            </div>
        </div>
        
        <div class="stat-card">
            <div class="stat-icon">üï∏Ô∏è</div>
            <div class="stat-info">
                <span class="stat-label">–°–≤—è–∑–µ–π</span>
                <span class="stat-value" id="totalRelationships">{{ stats.active_interactions }}</span>
            </div>
        </div>
        
        <div class="stat-card">
            <div class="stat-icon">üß†</div>
            <div class="stat-info">
                <span class="stat-label">–í–æ—Å–ø–æ–º–∏–Ω–∞–Ω–∏–π</span>
                <span class="stat-value" id="totalMemories">{{ stats.total_memories }}</span>
            </div>
        </div>
    </div>

    <!-- –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –º–∏—Ä–∞ -->
    <div class="world-viz-section">
        <h2>–ö–∞—Ä—Ç–∞ <span class="accent">–ø—Ä–∏—Å—É—Ç—Å—Ç–≤–∏—è</span></h2>
        <div class="viz-container">
            <canvas id="worldCanvas" width="900" height="400"></canvas>
            <div class="viz-legend">
                <div class="legend-item">
                    <span class="color-dot base"></span>
                    <span>–ë–∞–∑–æ–≤–∞—è –º–æ–¥–µ–ª—å</span>
                </div>
                <div class="legend-item">
                    <span class="color-dot advanced"></span>
                    <span>–ü—Ä–æ–¥–≤–∏–Ω—É—Ç–∞—è –º–æ–¥–µ–ª—å</span>
                </div>
                <div class="legend-item">
                    <span class="color-dot infinite"></span>
                    <span>–ë–µ—Å–∫–æ–Ω–µ—á–Ω–∞—è –º–æ–¥–µ–ª—å</span>
                </div>
                <div class="legend-item">
                    <span class="mood-indicator happy"></span>
                    <span>–ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ: —Ü–≤–µ—Ç –ø—É–ª—å—Å–∞—Ü–∏–∏</span>
                </div>
            </div>
        </div>
    </div>

    <!-- –°–ø–∏—Å–æ–∫ –∞–≥–µ–Ω—Ç–æ–≤ -->
    <div class="agents-section">
        <h2>–ê–∫—Ç–∏–≤–Ω—ã–µ <span class="accent">–∞–≥–µ–Ω—Ç—ã</span></h2>
        <div class="agents-grid">
            {% for agent in agents %}
            <div class="agent-card" onclick="window.location.href='{{ url_for('agent_detail', name=agent.name) }}'">
                <div class="agent-card-header">
                    <div class="agent-avatar" data-type="{{ agent.type }}">
                        {% if agent.type == '–ë–∞–∑–æ–≤–∞—è' %}üå±
                        {% elif agent.type == '–ü—Ä–æ–¥–≤–∏–Ω—É—Ç–∞—è' %}‚ö°
                        {% else %}‚àû{% endif %}
                    </div>
                    <div class="agent-info">
                        <h3 class="agent-name">{{ agent.name }}</h3>
                        <span class="agent-type-badge {{ agent.type.lower() }}">{{ agent.type }}</span>
                    </div>
                </div>
                
                <div class="agent-card-body">
                    <div class="agent-mood">
                        <span class="mood-label">–ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ:</span>
                        <span class="mood-value" data-mood="{{ agent.mood }}">{{ agent.mood }}</span>
                    </div>
                    
                    <div class="agent-energy">
                        <span class="energy-label">–≠–Ω–µ—Ä–≥–∏—è:</span>
                        <div class="energy-bar-container">
                            <div class="energy-bar">
                                <div class="energy-fill" style="width: {{ agent.energy * 100 }}%"></div>
                            </div>
                            <span class="energy-value">{{ "%.0f"|format(agent.energy * 100) }}%</span>
                        </div>
                    </div>
                    
                    <div class="agent-position">
                        <span class="position-label">–ü–æ–∑–∏—Ü–∏—è:</span>
                        <span class="position-value">
                            ({{ "%.1f"|format(agent.position_x) }}, 
                            {{ "%.1f"|format(agent.position_y) }}, 
                            {{ "%.1f"|format(agent.position_z) }})
                        </span>
                    </div>
                </div>
                
                <div class="agent-card-footer">
                    <span class="agent-last-active">–ê–∫—Ç–∏–≤–µ–Ω: {{ time_ago(agent.last_active) }}</span>
                    <span class="agent-details-link">–ü–æ–¥—Ä–æ–±–Ω–µ–µ ‚Üí</span>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const canvas = document.getElementById('worldCanvas');
    if (!canvas) return;
    
    const ctx = canvas.getContext('2d');
    
    function drawWorld() {
        fetch('/api/world-state')
            .then(response => response.json())
            .then(data => {
                // –û—á–∏—â–∞–µ–º –∫–∞–Ω–≤–∞—Å
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                // –†–∏—Å—É–µ–º —Å–µ—Ç–∫—É
                drawGrid(ctx, canvas.width, canvas.height);
                
                // –†–∏—Å—É–µ–º –∞–≥–µ–Ω—Ç–æ–≤
                if (data.agents && data.agents.length > 0) {
                    data.agents.forEach(agent => {
                        drawAgent(ctx, agent, canvas.width, canvas.height);
                    });
                }
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
                updateStats(data);
            })
            .catch(console.error);
    }
    
    function drawGrid(ctx, width, height) {
        ctx.strokeStyle = 'rgba(2, 124, 125, 0.1)';
        ctx.lineWidth = 1;
        
        // –í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–µ –ª–∏–Ω–∏–∏
        for (let x = 0; x <= width; x += 50) {
            ctx.beginPath();
            ctx.moveTo(x, 0);
            ctx.lineTo(x, height);
            ctx.stroke();
        }
        
        // –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–µ –ª–∏–Ω–∏–∏
        for (let y = 0; y <= height; y += 50) {
            ctx.beginPath();
            ctx.moveTo(0, y);
            ctx.lineTo(width, y);
            ctx.stroke();
        }
        
        // –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–µ –æ—Å–∏
        ctx.strokeStyle = 'rgba(230, 0, 106, 0.3)';
        ctx.lineWidth = 2;
        
        ctx.beginPath();
        ctx.moveTo(width/2, 0);
        ctx.lineTo(width/2, height);
        ctx.stroke();
        
        ctx.beginPath();
        ctx.moveTo(0, height/2);
        ctx.lineTo(width, height/2);
        ctx.stroke();
    }
    
    function drawAgent(ctx, agent, width, height) {
        // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –∏–∑ [-10,10] –≤ [0,width] –∏ [0,height]
        const x = (agent.position[0] / 20 + 0.5) * width;
        const y = (agent.position[1] / 20 + 0.5) * height;
        const size = 15 + agent.energy * 10;
        
        // –í—ã–±–∏—Ä–∞–µ–º —Ü–≤–µ—Ç –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç–∏–ø–∞ –∞–≥–µ–Ω—Ç–∞
        let baseColor;
        if (agent.type === '–ë–∞–∑–æ–≤–∞—è') {
            baseColor = '#027C7D';
        } else if (agent.type === '–ü—Ä–æ–¥–≤–∏–Ω—É—Ç–∞—è') {
            baseColor = '#E6006A';
        } else {
            baseColor = '#9b59b6';
        }
        
        // –í—ã–±–∏—Ä–∞–µ–º —Ü–≤–µ—Ç –ø—É–ª—å—Å–∞—Ü–∏–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è
        let pulseColor;
        switch(agent.mood) {
            case '–ª—é–±–æ–ø—ã—Ç–Ω—ã–π': pulseColor = 'rgba(46, 204, 113, 0.5)'; break;
            case '–≤–æ–∑–±—É–∂–¥–µ–Ω–Ω—ã–π': pulseColor = 'rgba(241, 196, 15, 0.5)'; break;
            case '—É—Å—Ç–∞–≤—à–∏–π': pulseColor = 'rgba(155, 89, 182, 0.5)'; break;
            case '—Å—Ñ–æ–∫—É—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π': pulseColor = 'rgba(52, 152, 219, 0.5)'; break;
            default: pulseColor = 'rgba(149, 165, 166, 0.5)';
        }
        
        // –†–∏—Å—É–µ–º –ø—É–ª—å—Å–∞—Ü–∏—é
        ctx.beginPath();
        ctx.arc(x, y, size + 5, 0, Math.PI * 2);
        ctx.fillStyle = pulseColor;
        ctx.fill();
        
        // –†–∏—Å—É–µ–º —Ç–µ–Ω—å
        ctx.shadowColor = baseColor;
        ctx.shadowBlur = 20;
        
        // –†–∏—Å—É–µ–º –∞–≥–µ–Ω—Ç–∞
        ctx.beginPath();
        ctx.arc(x, y, size, 0, Math.PI * 2);
        ctx.fillStyle = baseColor;
        ctx.fill();
        ctx.strokeStyle = '#fff';
        ctx.lineWidth = 2;
        ctx.stroke();
        
        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ç–µ–Ω—å
        ctx.shadowBlur = 0;
        
        // –†–∏—Å—É–µ–º –∏–º—è
        ctx.fillStyle = '#fff';
        ctx.font = 'bold 12px Inter, sans-serif';
        ctx.textAlign = 'center';
        ctx.fillText(agent.name, x, y - size - 10);
        
        // –†–∏—Å—É–µ–º —ç–Ω–µ—Ä–≥–∏—é
        ctx.fillStyle = 'rgba(255, 255, 255, 0.7)';
        ctx.font = '10px Inter, sans-serif';
        ctx.fillText(`‚ö°${agent.energy * 100}%`, x, y + size + 15);
    }
    
    function updateStats(data) {
        document.getElementById('worldCycle').textContent = data.cycle;
        document.getElementById('worldComplexity').textContent = data.complexity.toFixed(2);
        document.getElementById('totalAgents').textContent = data.agents.length;
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ä–µ–¥–Ω—é—é —ç–Ω–µ—Ä–≥–∏—é
        const avgEnergy = data.agents.reduce((sum, a) => sum + a.energy, 0) / data.agents.length;
        document.getElementById('avgEnergy').textContent = avgEnergy.toFixed(2);
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–≤—è–∑–µ–π –∏ –≤–æ—Å–ø–æ–º–∏–Ω–∞–Ω–∏–π (–º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –æ—Ç–¥–µ–ª—å–Ω—ã–µ API –ø–æ–∑–∂–µ)
    }
    
    // –†–∏—Å—É–µ–º –º–∏—Ä –∏ –æ–±–Ω–æ–≤–ª—è–µ–º –∫–∞–∂–¥—ã–µ 3 —Å–µ–∫—É–Ω–¥—ã
    drawWorld();
    setInterval(drawWorld, 3000);
});
</script>
{% endblock %}